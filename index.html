<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>dual-speed-mobile v0.1-beta</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
  -webkit-tap-highlight-color: transparent;
}
:root {
  --bg-dark: #0f172a;
  --bg-medium: #1e293b;
  --bg-light: #334155;
  --bg-card: #1e293b;
  --border: #334155;
  --accent: #6366f1;
  --accent-bright: #818cf8;
  --text-primary: #f1f5f9;
  --text-secondary: #cbd5e1;
  --text-muted: #94a3b8;
  --success: #10b981;
  --warning: #f59e0b;
  --error: #ef4444;
  --download: #38bdf8;
  --upload: #8b5cf6;
  --ping: #fbbf24;
}
body {
  background: linear-gradient(135deg, var(--bg-dark) 0%, #1e293b 100%);
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.5;
  padding: 0;
  margin: 0;
  overflow-x: hidden;
  touch-action: manipulation;
}
.app-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-width: 100%;
  margin: 0 auto;
  padding: 16px;
  gap: 16px;
}
/* Header */
.header {
  background: rgba(30, 41, 59, 0.8);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  border: 1px solid var(--border);
  position: relative;
  overflow: hidden;
  z-index: 10;
}
.header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--download), var(--upload), var(--ping));
}
.logo-section {
  text-align: center;
  width: 100%;
}
.logo-section h1 {
  font-size: 24px;
  font-weight: 800;
  letter-spacing: -0.5px;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.logo-section p {
  color: var(--text-secondary);
  font-size: 14px;
  margin-top: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.connection-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
  text-align: center;
  margin-top: 8px;
}
.connection-info-item {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 13px;
}
.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}
.status-dot.loading {
  background: var(--warning);
  animation: blink 1s infinite;
}
.status-dot.success {
  background: var(--success);
}
.status-dot.error {
  background: var(--error);
}
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}
.connection-type-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: lowercase;
  letter-spacing: 0.5px;
  background: rgba(99, 102, 241, 0.15);
  color: var(--accent);
  border: 1px solid rgba(99, 102, 241, 0.3);
}
/* Main Content */
.main-content {
  display: flex;
  flex-direction: column;
  gap: 16px;
  flex: 1;
  overflow-y: auto;
  padding-bottom: 60px;
}
/* Speedometer Section */
.speed-section {
  background: linear-gradient(135deg, var(--bg-card) 0%, #2c3a55 100%);
  border-radius: 24px;
  border: 1px solid var(--border);
  padding: 24px 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
  position: relative;
  overflow: hidden;
}
.circle-container {
  width: 240px;
  height: 240px;
  position: relative;
  margin: 0 auto 16px;
}
.speed-circle {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: conic-gradient(var(--download) 0%, var(--accent-bright) 25%, var(--upload) 50%, var(--warning) 75%, var(--error) 100%);
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
}
.speed-circle-inner {
  width: 180px;
  height: 180px;
  border-radius: 50%;
  background: var(--bg-card);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.current-speed {
  font-size: 48px;
  font-weight: 800;
  color: var(--accent);
}
.speed-unit {
  font-size: 16px;
  color: var(--text-secondary);
}
.test-type {
  font-size: 16px;
  color: var(--text-secondary);
  margin-top: 8px;
  text-align: center;
}
.start-button {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent-bright));
  border: none;
  color: white;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 6px 15px rgba(99, 102, 241, 0.4);
  transition: all 0.2s ease;
  margin: 20px 0 16px;
}
.start-button:hover {
  transform: scale(1.05);
  box-shadow: 0 8px 20px rgba(99, 102, 241, 0.5);
}
.start-button:active {
  transform: scale(0.95);
}
.start-button i {
  font-size: 28px;
}
.start-button.testing {
  animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0%, 100% { box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }
  50% { box-shadow: 0 0 25px rgba(99, 102, 241, 0.7); }
}
.progress-section {
  width: 100%;
  margin-top: 16px;
}
.progress-header {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.progress-bar {
  width: 100%;
  height: 8px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--download), var(--upload));
  width: 0%;
  transition: width 0.3s ease;
  border-radius: 4px;
  position: relative;
}
.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  animation: shimmer 1.5s infinite;
}
@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}
/* Results Panel */
.panel-card {
  background: linear-gradient(135deg, var(--bg-card) 0%, #2c3a55 100%);
  border-radius: 20px;
  border: 1px solid var(--border);
  padding: 20px 16px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}
.panel-title {
  color: var(--accent);
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.result-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}
.result-item {
  background: rgba(255, 255, 255, 0.04);
  border-radius: 16px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  border: 1px solid rgba(255, 255, 255, 0.08);
}
.result-icon {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  margin-bottom: 4px;
}
.result-icon.download {
  background: rgba(56, 189, 248, 0.15);
  color: var(--download);
}
.result-icon.upload {
  background: rgba(139, 92, 246, 0.15);
  color: var(--upload);
}
.result-icon.ping {
  background: rgba(251, 191, 36, 0.15);
  color: var(--ping);
}
.result-icon.jitter {
  background: rgba(99, 102, 241, 0.15);
  color: var(--accent);
}
.result-label {
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: 4px;
}
.result-value {
  font-size: 24px;
  font-weight: 700;
  font-family: 'Roboto Mono', monospace;
}
.result-unit {
  font-size: 12px;
  color: var(--text-secondary);
  margin-left: 2px;
}
.result-rating {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
  margin-top: 4px;
}
/* History and Server Info */
.history-item,
.server-item {
  background: rgba(255, 255, 255, 0.04);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 8px;
  font-size: 13px;
  border: 1px solid rgba(255, 255, 255, 0.08);
}
.history-item:last-child,
.server-item:last-child {
  margin-bottom: 0;
}
.history-date {
  color: var(--text-muted);
  font-size: 12px;
  margin-bottom: 4px;
}
.history-speeds {
  display: flex;
  justify-content: space-between;
  gap: 12px;
}
.history-speed {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 13px;
}
/* Footer Navigation */
.footer-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(30, 41, 59, 0.9);
  backdrop-filter: blur(10px);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-around;
  padding: 12px 0;
  z-index: 100;
  box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
}
.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  color: var(--text-muted);
  text-decoration: none;
  padding: 8px 0;
  flex: 1;
  transition: all 0.2s ease;
}
.nav-item.active {
  color: var(--accent);
}
.nav-item i {
  font-size: 18px;
}
.nav-item:hover {
  color: var(--accent-bright);
}
/* Rating Badge */
.rating-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 16px;
  border-radius: 50px;
  font-size: 16px;
  font-weight: 700;
  margin: 12px 0;
  background: rgba(99, 102, 241, 0.15);
  color: var(--accent);
  border: 1px solid rgba(99, 102, 241, 0.3);
}
/* Version Badge */
.version-badge {
  position: absolute;
  top: 8px;
  right: 8px;
  background: rgba(245, 158, 11, 0.15);
  color: var(--warning);
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 12px;
  font-weight: 600;
  z-index: 5;
}
/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.panel-card {
  animation: fadeIn 0.4s ease-out;
}
/* Modal */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
.modal.active {
  opacity: 1;
  pointer-events: all;
}
.modal-content {
  background: linear-gradient(135deg, var(--bg-card) 0%, #2c3a55 100%);
  border-radius: 24px;
  border: 1px solid var(--border);
  width: 90%;
  max-width: 400px;
  padding: 24px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  transform: scale(0.95);
  opacity: 0;
  transition: all 0.3s ease;
}
.modal.active .modal-content {
  transform: scale(1);
  opacity: 1;
}
.modal-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 16px;
  text-align: center;
  color: var(--accent);
}
.modal-text {
  color: var(--text-secondary);
  font-size: 14px;
  line-height: 1.6;
  margin-bottom: 20px;
}
.modal-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
}
.modal-btn {
  padding: 10px 20px;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.modal-btn.primary {
  background: linear-gradient(135deg, var(--accent), var(--accent-bright));
  color: white;
}
.modal-btn.outline {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-secondary);
}
.modal-btn:hover {
  transform: translateY(-2px);
}
.modal-btn:active {
  transform: translateY(0);
}
/* Media Queries */
@media (max-width: 320px) {
  .circle-container {
    width: 220px;
    height: 220px;
  }
  .speed-circle-inner {
    width: 160px;
    height: 160px;
  }
  .current-speed {
    font-size: 40px;
  }
  .start-button {
    width: 70px;
    height: 70px;
  }
  .result-value {
    font-size: 20px;
  }
}
</style>
</head>
<body>
<div class="app-container">
  <!-- Header -->
  <header class="header">
    <div class="logo-section">
      <h1><i class="fas fa-mobile-alt"></i> dual-speed-mobile</h1>
      <p><i class="fas fa-wifi"></i> –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Ç–µ—Å—Ç–µ—Ä v0.1-beta</p>
    </div>
    <div class="connection-info">
      <div class="connection-info-item">
        <i class="fas fa-map-marker-alt"></i>
        <span class="value" id="header-location">
          <span class="status-dot loading"></span>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...
        </span>
      </div>
      <div class="connection-info-item">
        <i class="fas fa-building"></i>
        <span class="value" id="header-isp">
          <span class="status-dot loading"></span>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞...
        </span>
      </div>
      <div class="connection-info-item">
        <i class="fas fa-network-wired"></i>
        <span class="value" id="header-connection">
          <span class="connection-type-badge" id="connection-badge">
            <i class="fas fa-circle-notch fa-spin"></i> –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...
          </span>
        </span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Speed Section -->
    <div class="speed-section">
      <div class="circle-container">
        <div class="speed-circle" id="speed-circle">
          <div class="speed-circle-inner">
            <div class="current-speed" id="current-speed">0</div>
            <div class="speed-unit" id="speed-unit">Mbps</div>
          </div>
        </div>
      </div>
      <div class="test-type" id="test-type">–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç—É</div>
      
      <button class="start-button" id="start-btn">
        <i class="fas fa-play"></i>
      </button>
      
      <div class="progress-section">
        <div class="progress-header">
          <span id="progress-status">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞</span>
          <span id="progress-percent">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>
      
      <div class="rating-badge" id="rating-badge" style="display: none;">
        <i class="fas fa-signal"></i>
        <span id="rating-text">–•–æ—Ä–æ—à–µ–µ</span>
      </div>
    </div>
    
    <!-- Results Panel -->
    <div class="panel-card">
      <div class="panel-title">
        <i class="fas fa-chart-line"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞
      </div>
      <div class="result-grid">
        <div class="result-item">
          <div class="result-icon download">
            <i class="fas fa-arrow-down"></i>
          </div>
          <div class="result-label">–°–∫–∞—á–∏–≤–∞–Ω–∏–µ</div>
          <div class="result-value" id="download-result" style="color: var(--download)">
            ‚Äî<span class="result-unit">Mbps</span>
          </div>
          <div class="result-rating" id="download-rating"></div>
        </div>
        <div class="result-item">
          <div class="result-icon upload">
            <i class="fas fa-arrow-up"></i>
          </div>
          <div class="result-label">–ó–∞–≥—Ä—É–∑–∫–∞</div>
          <div class="result-value" id="upload-result" style="color: var(--upload)">
            ‚Äî<span class="result-unit">Mbps</span>
          </div>
          <div class="result-rating" id="upload-rating"></div>
        </div>
        <div class="result-item">
          <div class="result-icon ping">
            <i class="fas fa-exchange-alt"></i>
          </div>
          <div class="result-label">–ü–∏–Ω–≥</div>
          <div class="result-value" id="ping-result" style="color: var(--ping)">
            ‚Äî<span class="result-unit">ms</span>
          </div>
          <div class="result-rating" id="ping-rating"></div>
        </div>
        <div class="result-item">
          <div class="result-icon jitter">
            <i class="fas fa-wave-square"></i>
          </div>
          <div class="result-label">–î–∂–∏—Ç—Ç–µ—Ä</div>
          <div class="result-value" id="jitter-result" style="color: var(--accent)">
            ‚Äî<span class="result-unit">ms</span>
          </div>
          <div class="result-rating" id="jitter-rating"></div>
        </div>
      </div>
    </div>
    
    <!-- History -->
    <div class="panel-card">
      <div class="panel-title">
        <i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤
      </div>
      <div id="history-container">
        <div class="history-item">
          <div class="history-date">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>
        </div>
      </div>
    </div>
    
    <!-- Connection Info -->
    <div class="panel-card">
      <div class="panel-title">
        <i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
      </div>
      <div id="connection-info-container">
        <div class="server-item">
          <div class="server-item-label">
            <i class="fas fa-fingerprint"></i> IP –∞–¥—Ä–µ—Å
          </div>
          <div class="server-item-value loading" id="ip-address">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...</div>
        </div>
        <div class="server-item">
          <div class="server-item-label">
            <i class="fas fa-building"></i> –ü—Ä–æ–≤–∞–π–¥–µ—Ä
          </div>
          <div class="server-item-value loading" id="isp-name">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...</div>
        </div>
        <div class="server-item">
          <div class="server-item-label">
            <i class="fas fa-server"></i> –°–µ—Ä–≤–µ—Ä
          </div>
          <div class="server-item-value">Cloudflare CDN</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Footer Navigation -->
  <div class="footer-nav">
    <a href="#" class="nav-item active">
      <i class="fas fa-tachometer-alt"></i>
      <span>–¢–µ—Å—Ç</span>
    </a>
    <a href="#" class="nav-item" id="nav-history">
      <i class="fas fa-history"></i>
      <span>–ò—Å—Ç–æ—Ä–∏—è</span>
    </a>
    <a href="#" class="nav-item" id="nav-settings">
      <i class="fas fa-cog"></i>
      <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
    </a>
  </div>
  
  <!-- Settings Modal -->
  <div class="modal" id="settings-modal">
    <div class="modal-content">
      <div class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <div class="modal-text">
        <p>–í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: v0.1-beta</p>
        <p>–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω–æ–≤</p>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn outline" id="close-settings">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script>
// Mobile-optimized Speed Tester v0.1-beta
document.addEventListener('DOMContentLoaded', () => {
  // DOM Elements
  const startBtn = document.getElementById('start-btn');
  const currentSpeed = document.getElementById('current-speed');
  const testType = document.getElementById('test-type');
  const speedCircle = document.getElementById('speed-circle');
  const speedUnit = document.getElementById('speed-unit');
  const progressFill = document.getElementById('progress-fill');
  const progressStatus = document.getElementById('progress-status');
  const progressPercent = document.getElementById('progress-percent');
  const downloadResult = document.getElementById('download-result');
  const uploadResult = document.getElementById('upload-result');
  const pingResult = document.getElementById('ping-result');
  const jitterResult = document.getElementById('jitter-result');
  const downloadRating = document.getElementById('download-rating');
  const uploadRating = document.getElementById('upload-rating');
  const pingRating = document.getElementById('ping-rating');
  const jitterRating = document.getElementById('jitter-rating');
  const ratingBadge = document.getElementById('rating-badge');
  const ratingText = document.getElementById('rating-text');
  const ipAddress = document.getElementById('ip-address');
  const ispName = document.getElementById('isp-name');
  const headerLocation = document.getElementById('header-location');
  const headerIsp = document.getElementById('header-isp');
  const connectionBadge = document.getElementById('connection-badge');
  const navHistory = document.getElementById('nav-history');
  const navSettings = document.getElementById('nav-settings');
  const settingsModal = document.getElementById('settings-modal');
  const closeSettings = document.getElementById('close-settings');
  
  // Test state
  let isTesting = false;
  let testResults = {
    download: 0,
    upload: 0,
    ping: 0,
    jitter: 0
  };
  
  // Rating levels
  const RATING_LEVELS = [
    { name: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ', min: 0, max: 15, color: '#ef4444' },
    { name: '–û—á–µ–Ω—å –ø–ª–æ—Ö–æ', min: 15, max: 30, color: '#f97316' },
    { name: '–ü–ª–æ—Ö–æ', min: 30, max: 45, color: '#f59e0b' },
    { name: '–°—Ä–µ–¥–Ω–µ', min: 45, max: 60, color: '#eab308' },
    { name: '–•–æ—Ä–æ—à–æ', min: 60, max: 75, color: '#86efac' },
    { name: '–û—Ç–ª–∏—á–Ω–æ', min: 75, max: 90, color: '#34d399' },
    { name: '–°—É–ø–µ—Ä', min: 90, max: 101, color: '#6366f1' }
  ];
  
  // Initialize
  setupEventListeners();
  getConnectionInfo();
  loadHistory();
  
  function setupEventListeners() {
    startBtn.addEventListener('click', toggleTest);
    navSettings.addEventListener('click', (e) => {
      e.preventDefault();
      settingsModal.classList.add('active');
    });
    closeSettings.addEventListener('click', () => {
      settingsModal.classList.remove('active');
    });
    
    // Close modal when clicking outside
    settingsModal.addEventListener('click', (e) => {
      if (e.target === settingsModal) {
        settingsModal.classList.remove('active');
      }
    });
    
    // Prevent zoom on double tap
    document.addEventListener('touchstart', function(event) {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false });
    
    // Prevent pull-to-refresh
    document.body.addEventListener('touchmove', function(event) {
      if (event.touches.length === 1) {
        const scrollY = window.scrollY;
        if (scrollY === 0) {
          event.preventDefault();
        }
      }
    }, { passive: false });
  }
  
  function toggleTest() {
    if (isTesting) {
      stopTest();
    } else {
      startTest();
    }
  }
  
  async function startTest() {
    isTesting = true;
    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    startBtn.classList.add('testing');
    resetResults();
    ratingBadge.style.display = 'none';
    
    try {
      await runPingTest();
      await runDownloadTest();
      await runUploadTest();
      completeTest();
    } catch (error) {
      console.error('Test error:', error);
      testType.textContent = '–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞';
      resetTestState();
    }
  }
  
  function stopTest() {
    // In a real implementation, this would abort ongoing fetch requests
    console.log('Stopping test...');
    resetTestState();
  }
  
  function resetTestState() {
    isTesting = false;
    startBtn.innerHTML = '<i class="fas fa-play"></i>';
    startBtn.classList.remove('testing');
  }
  
  function resetResults() {
    currentSpeed.textContent = '0';
    speedUnit.textContent = 'Mbps';
    testType.textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–∞...';
    progressFill.style.width = '0%';
    progressStatus.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞';
    progressPercent.textContent = '0%';
    
    // Reset result displays
    downloadResult.innerHTML = '‚Äî<span class="result-unit">Mbps</span>';
    uploadResult.innerHTML = '‚Äî<span class="result-unit">Mbps</span>';
    pingResult.innerHTML = '‚Äî<span class="result-unit">ms</span>';
    jitterResult.innerHTML = '‚Äî<span class="result-unit">ms</span>';
    
    // Clear ratings
    downloadRating.textContent = '';
    uploadRating.textContent = '';
    pingRating.textContent = '';
    jitterRating.textContent = '';
  }
  
  async function runPingTest() {
    testType.textContent = '–¢–µ—Å—Ç –ø–∏–Ω–≥–∞...';
    progressStatus.textContent = '–ü–∏–Ω–≥';
    speedUnit.textContent = 'ms';
    
    const pings = [];
    const testUrl = 'https://www.cloudflare.com/cdn-cgi/trace';
    
    for (let i = 0; i < 5; i++) {
      const start = performance.now();
      try {
        await fetch(testUrl + '?_=' + Date.now(), { 
          mode: 'cors', 
          cache: 'no-store',
          signal: AbortSignal.timeout(5000) // 5 second timeout
        });
        const ping = performance.now() - start;
        pings.push(ping);
        currentSpeed.textContent = Math.round(ping);
        
        // Update progress (0-30% for ping test)
        const progress = Math.min(30, (i + 1) * 6);
        progressFill.style.width = `${progress}%`;
        progressPercent.textContent = `${progress}%`;
      } catch (e) {
        pings.push(300 + Math.random() * 200); // Fallback value
      }
      
      await sleep(300);
    }
    
    if (pings.length > 0) {
      testResults.ping = Math.round(pings.reduce((a, b) => a + b, 0) / pings.length);
      testResults.jitter = pings.length > 1 
        ? Math.round(calculateJitter(pings))
        : 0;
    } else {
      testResults.ping = 300;
      testResults.jitter = 50;
    }
    
    pingResult.innerHTML = `${testResults.ping}<span class="result-unit">ms</span>`;
    jitterResult.innerHTML = `${testResults.jitter}<span class="result-unit">ms</span>`;
    
    updateMetricRating('ping', testResults.ping, pingRating);
    updateMetricRating('jitter', testResults.jitter, jitterRating);
    
    progressFill.style.width = '30%';
    progressPercent.textContent = '30%';
  }
  
  function calculateJitter(pings) {
    if (pings.length < 2) return 0;
    let sum = 0;
    for (let i = 1; i < pings.length; i++) {
      sum += Math.abs(pings[i] - pings[i-1]);
    }
    return sum / (pings.length - 1);
  }
  
  async function runDownloadTest() {
    testType.textContent = '–¢–µ—Å—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏—è...';
    progressStatus.textContent = '–°–∫–∞—á–∏–≤–∞–Ω–∏–µ';
    speedUnit.textContent = 'Mbps';
    currentSpeed.style.color = '#38bdf8';
    
    const sizes = [100000, 500000, 1000000, 2000000]; // Smaller sizes for mobile
    const speeds = [];
    const startTime = performance.now();
    const duration = 5000; // 5 seconds for mobile
    
    let completed = 0;
    while (performance.now() - startTime < duration && completed < 8) {
      const size = sizes[completed % sizes.length];
      
      try {
        const downloadStart = performance.now();
        const response = await fetch(`https://speed.cloudflare.com/__down?bytes=${size}&_=${Date.now()}`, {
          cache: 'no-store',
          signal: AbortSignal.timeout(3000) // 3 second timeout per download
        });
        
        // Read response fully
        const contentLength = response.headers.get('Content-Length');
        const reader = response.body.getReader();
        let receivedLength = 0;
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          receivedLength += value.length;
        }
        
        const downloadTime = (performance.now() - downloadStart) / 1000;
        if (downloadTime > 0.1 && contentLength) { // Ignore very fast downloads
          const actualBytes = parseInt(contentLength);
          const speedMbps = (actualBytes * 8) / (downloadTime * 1000000);
          speeds.push(speedMbps);
          
          currentSpeed.textContent = speedMbps.toFixed(1);
          
          // Update gauge color based on speed
          updateSpeedCircle(speedMbps, '#38bdf8');
        }
        
        // Update progress (30-65% for download test)
        completed++;
        const progress = 30 + Math.min(35, (completed / 8) * 35);
        progressFill.style.width = `${progress}%`;
        progressPercent.textContent = `${Math.round(progress)}%`;
      } catch (e) {
        console.log('Download error:', e);
      }
      
      await sleep(100);
    }
    
    if (speeds.length > 0) {
      // Use median value to avoid outliers
      speeds.sort((a, b) => a - b);
      testResults.download = parseFloat(speeds[Math.floor(speeds.length / 2)].toFixed(1));
    } else {
      testResults.download = 0.1; // Fallback value
    }
    
    downloadResult.innerHTML = `${testResults.download}<span class="result-unit">Mbps</span>`;
    updateMetricRating('download', testResults.download, downloadRating);
    
    progressFill.style.width = '65%';
    progressPercent.textContent = '65%';
  }
  
  async function runUploadTest() {
    testType.textContent = '–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏...';
    progressStatus.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞';
    speedUnit.textContent = 'Mbps';
    currentSpeed.style.color = '#8b5cf6';
    
    // Generate random data for upload
    const generateData = (size) => {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < size; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    };
    
    const sizes = [50000, 100000, 200000]; // Smaller sizes for mobile
    const speeds = [];
    const startTime = performance.now();
    const duration = 4000; // 4 seconds for mobile
    
    let completed = 0;
    while (performance.now() - startTime < duration && completed < 6) {
      const size = sizes[completed % sizes.length];
      const data = generateData(size);
      
      try {
        const uploadStart = performance.now();
        await fetch('https://speed.cloudflare.com/__up', {
          method: 'POST',
          body: data,
          cache: 'no-store',
          signal: AbortSignal.timeout(3000) // 3 second timeout per upload
        });
        
        const uploadTime = (performance.now() - uploadStart) / 1000;
        if (uploadTime > 0.1) {
          const speedMbps = (size * 8) / (uploadTime * 1000000);
          speeds.push(speedMbps);
          
          currentSpeed.textContent = speedMbps.toFixed(1);
          
          // Update gauge color based on speed
          updateSpeedCircle(speedMbps, '#8b5cf6');
        }
        
        // Update progress (65-100% for upload test)
        completed++;
        const progress = 65 + Math.min(35, (completed / 6) * 35);
        progressFill.style.width = `${progress}%`;
        progressPercent.textContent = `${Math.round(progress)}%`;
      } catch (e) {
        console.log('Upload error:', e);
      }
      
      await sleep(100);
    }
    
    if (speeds.length > 0) {
      // Use median value to avoid outliers
      speeds.sort((a, b) => a - b);
      testResults.upload = parseFloat(speeds[Math.floor(speeds.length / 2)].toFixed(1));
    } else {
      testResults.upload = 0.05; // Fallback value
    }
    
    uploadResult.innerHTML = `${testResults.upload}<span class="result-unit">Mbps</span>`;
    updateMetricRating('upload', testResults.upload, uploadRating);
    
    progressFill.style.width = '100%';
    progressPercent.textContent = '100%';
  }
  
  function updateMetricRating(metric, value, element) {
    const thresholds = {
      download: [
        { max: 1, color: '#ef4444', text: '–û—á–µ–Ω—å –ø–ª–æ—Ö–æ' },
        { max: 5, color: '#f97316', text: '–ü–ª–æ—Ö–æ' },
        { max: 15, color: '#f59e0b', text: '–°—Ä–µ–¥–Ω–µ' },
        { max: 30, color: '#eab308', text: '–•–æ—Ä–æ—à–æ' },
        { max: 60, color: '#86efac', text: '–û—Ç–ª–∏—á–Ω–æ' },
        { max: Infinity, color: '#34d399', text: '–°—É–ø–µ—Ä' }
      ],
      upload: [
        { max: 0.5, color: '#ef4444', text: '–û—á–µ–Ω—å –ø–ª–æ—Ö–æ' },
        { max: 2, color: '#f97316', text: '–ü–ª–æ—Ö–æ' },
        { max: 5, color: '#f59e0b', text: '–°—Ä–µ–¥–Ω–µ' },
        { max: 15, color: '#eab308', text: '–•–æ—Ä–æ—à–æ' },
        { max: 30, color: '#86efac', text: '–û—Ç–ª–∏—á–Ω–æ' },
        { max: Infinity, color: '#34d399', text: '–°—É–ø–µ—Ä' }
      ],
      ping: [
        { max: 50, color: '#34d399', text: '–°—É–ø–µ—Ä' },
        { max: 100, color: '#86efac', text: '–û—Ç–ª–∏—á–Ω–æ' },
        { max: 150, color: '#eab308', text: '–•–æ—Ä–æ—à–æ' },
        { max: 200, color: '#f59e0b', text: '–°—Ä–µ–¥–Ω–µ' },
        { max: 300, color: '#f97316', text: '–ü–ª–æ—Ö–æ' },
        { max: Infinity, color: '#ef4444', text: '–û—á–µ–Ω—å –ø–ª–æ—Ö–æ' }
      ],
      jitter: [
        { max: 10, color: '#34d399', text: '–°—É–ø–µ—Ä' },
        { max: 20, color: '#86efac', text: '–û—Ç–ª–∏—á–Ω–æ' },
        { max: 40, color: '#eab308', text: '–•–æ—Ä–æ—à–æ' },
        { max: 70, color: '#f59e0b', text: '–°—Ä–µ–¥–Ω–µ' },
        { max: 100, color: '#f97316', text: '–ü–ª–æ—Ö–æ' },
        { max: Infinity, color: '#ef4444', text: '–û—á–µ–Ω—å –ø–ª–æ—Ö–æ' }
      ]
    };
    
    for (const threshold of thresholds[metric]) {
      if (value <= threshold.max) {
        element.textContent = threshold.text;
        element.style.backgroundColor = threshold.color + '20';
        element.style.color = threshold.color;
        return;
      }
    }
  }
  
  function updateSpeedCircle(speed, color) {
    // Calculate percentage (capped at 100% for visual purposes)
    const percentage = Math.min(100, speed / 50 * 100); // 50 Mbps is 100%
    
    // Update the conic gradient
    speedCircle.style.background = `conic-gradient(${color} ${percentage}%, rgba(255, 255, 255, 0.1) ${percentage}%, rgba(255, 255, 255, 0.1) 100%)`;
  }
  
  function completeTest() {
    resetTestState();
    testType.textContent = '–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω';
    progressStatus.textContent = '–ì–æ—Ç–æ–≤–æ';
    
    // Show rating badge
    const rating = calculateRating();
    ratingText.textContent = rating.name;
    ratingBadge.style.display = 'inline-flex';
    ratingBadge.style.background = rating.color + '15';
    ratingBadge.style.borderColor = rating.color + '33';
    ratingBadge.style.color = rating.color;
    
    // Update gauge to show rating
    const ratingPercentage = rating.min + (rating.max - rating.min) / 2;
    updateSpeedCircle(ratingPercentage, rating.color);
    currentSpeed.textContent = rating.name;
    currentSpeed.style.color = rating.color;
    speedUnit.style.display = 'none';
    
    // Save to history
    saveToHistory();
    
    // Try to detect connection type
    detectConnectionType();
  }
  
  function calculateRating() {
    // Simple rating calculation for mobile version
    let score = 0;
    
    // Download contributes 40% to score
    score += Math.min(40, testResults.download * 0.8);
    
    // Upload contributes 20% to score
    score += Math.min(20, testResults.upload * 2);
    
    // Ping contributes 30% to score (lower is better)
    score += Math.max(0, 30 - (testResults.ping / 10));
    
    // Jitter contributes 10% to score (lower is better)
    score += Math.max(0, 10 - (testResults.jitter / 5));
    
    score = Math.round(Math.max(0, Math.min(100, score)));
    
    // Find matching rating level
    for (const level of RATING_LEVELS) {
      if (score >= level.min && score < level.max) {
        return {
          name: level.name,
          score: score,
          color: level.color
        };
      }
    }
    
    return RATING_LEVELS[RATING_LEVELS.length - 1];
  }
  
  function saveToHistory() {
    const history = JSON.parse(localStorage.getItem('dualspeed_mobile_history') || '[]');
    
    const now = new Date();
    const historyItem = {
      date: now.toISOString(),
      download: testResults.download,
      upload: testResults.upload,
      ping: testResults.ping,
      jitter: testResults.jitter,
      rating: calculateRating()
    };
    
    history.unshift(historyItem);
    
    // Keep only last 10 items
    if (history.length > 10) {
      history.pop();
    }
    
    localStorage.setItem('dualspeed_mobile_history', JSON.stringify(history));
    renderHistory(history);
  }
  
  function renderHistory(history) {
    const container = document.getElementById('history-container');
    
    if (!history || history.length === 0) {
      container.innerHTML = `
        <div class="history-item">
          <div class="history-date">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>
        </div>
      `;
      return;
    }
    
    let html = '';
    history.slice(0, 5).forEach(item => {
      const date = new Date(item.date);
      const formattedDate = date.toLocaleDateString('ru-RU', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      html += `
        <div class="history-item">
          <div class="history-date">${formattedDate}</div>
          <div class="history-speeds">
            <span class="history-speed">
              <i class="fas fa-arrow-down" style="color: #38bdf8;"></i> ${item.download} Mbps
            </span>
            <span class="history-speed">
              <i class="fas fa-arrow-up" style="color: #8b5cf6;"></i> ${item.upload} Mbps
            </span>
          </div>
          <div class="history-speeds">
            <span class="history-speed">
              <i class="fas fa-exchange-alt" style="color: #fbbf24;"></i> ${item.ping} ms
            </span>
            <span style="color: ${item.rating.color}; font-weight: 500;">
              ${item.rating.name}
            </span>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }
  
  function loadHistory() {
    const history = JSON.parse(localStorage.getItem('dualspeed_mobile_history') || '[]');
    renderHistory(history);
  }
  
  function detectConnectionType() {
    // Simplified connection type detection for mobile
    if (!navigator.connection) {
      updateConnectionBadge('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', '#94a3b8');
      return;
    }
    
    const connection = navigator.connection;
    const downlink = connection.downlink || 0;
    const effectiveType = connection.effectiveType || 'unknown';
    
    let connectionType = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    let color = '#94a3b8';
    
    if (connection.type === 'wifi') {
      connectionType = downlink > 5 ? 'Wi-Fi' : '–°–ª–∞–±—ã–π Wi-Fi';
      color = downlink > 5 ? '#38bdf8' : '#fbbf24';
    } else if (connection.type === 'cellular') {
      if (effectiveType === '4g' || effectiveType === '3g') {
        connectionType = effectiveType.toUpperCase();
        color = effectiveType === '4g' ? '#86efac' : '#fbbf24';
      } else {
        connectionType = '–ú–æ–±–∏–ª—å–Ω—ã–π';
        color = '#8b5cf6';
      }
    } else if (connection.type === 'ethernet') {
      connectionType = 'Ethernet';
      color = '#6366f1';
    }
    
    updateConnectionBadge(connectionType, color);
  }
  
  function updateConnectionBadge(text, color) {
    connectionBadge.innerHTML = `<i class="fas fa-wifi"></i> ${text}`;
    connectionBadge.style.color = color;
    connectionBadge.style.borderColor = color + '33';
  }
  
  async function getConnectionInfo() {
    try {
      // Get IP and location info
      const response = await fetch('https://ipapi.co/json/', {
        mode: 'cors',
        cache: 'no-store'
      });
      
      if (!response.ok) {
        throw new Error('Failed to fetch IP info');
      }
      
      const data = await response.json();
      
      if (data.ip) {
        ipAddress.textContent = data.ip;
        ipAddress.classList.remove('loading');
        
        headerLocation.innerHTML = `<span class="status-dot success"></span>${data.city || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}, ${data.country_name || ''}`;
        headerLocation.classList.remove('loading');
        headerLocation.classList.add('success');
      }
      
      if (data.org) {
        ispName.textContent = data.org;
        ispName.classList.remove('loading');
        
        headerIsp.innerHTML = `<span class="status-dot success"></span>${data.org}`;
        headerIsp.classList.remove('loading');
        headerIsp.classList.add('success');
      }
      
      // Initial connection type detection
      detectConnectionType();
      
    } catch (error) {
      console.error('Error getting connection info:', error);
      ipAddress.textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
      ispName.textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
      headerLocation.innerHTML = '<span class="status-dot error"></span>–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
      headerIsp.innerHTML = '<span class="status-dot error"></span>–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
    }
  }
  
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
  
  // Prevent zoom on input focus
  document.addEventListener('focusin', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      document.body.style.zoom = '90%';
    }
  });
  
  document.addEventListener('focusout', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      document.body.style.zoom = '100%';
    }
  });
  
  console.log('üì± dual-speed-mobile v0.1-beta initialized');
});
</script>
</body>
</html>
